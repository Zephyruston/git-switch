#!/bin/bash

# Git Account Switcher - Config-based version

CONFIG_FILE="$HOME/.config/git-switch/accounts.conf"

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Config file not found at $CONFIG_FILE"
    echo "Please create the config file first."
    exit 1
fi

echo "Git Account Switcher"
echo "===================="
echo ""
echo "Choose account:"

# Read and display accounts from config
accounts=()
counter=1
while IFS='|' read -r name email ssh_key description hosts || [ -n "$name" ]; do
    # Skip comments and empty lines
    [[ "$name" =~ ^#.*$ ]] && continue
    [[ -z "$name" ]] && continue
    
    accounts+=("$name|$email|$ssh_key|$description|$hosts")
    echo "$counter) $name ($description - $email)"
    ((counter++))
done < "$CONFIG_FILE"

echo ""
read -p "Enter choice (1-$((counter-1))): " choice

# Validate choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt $((counter-1)) ]; then
    echo "Invalid choice"
    exit 1
fi

# Get selected account
selected_account="${accounts[$((choice-1))]}"
IFS='|' read -r name email ssh_key description hosts <<< "$selected_account"

# Backup original SSH config if it exists and hasn't been backed up
if [ -f ~/.ssh/config ] && [ ! -f ~/.ssh/config.original ]; then
    cp ~/.ssh/config ~/.ssh/config.original
fi

# Generate SSH config
cat > ~/.ssh/config << EOF
# Generated by git-switch for: $name ($description)
EOF

# Add host configurations
IFS=',' read -ra HOST_ARRAY <<< "$hosts"
for host in "${HOST_ARRAY[@]}"; do
    case "$host" in
        github)
            cat >> ~/.ssh/config << EOF

Host github.com
    HostName github.com
    User git
    IdentityFile $ssh_key
    IdentitiesOnly yes
EOF
            ;;
        bitbucket)
            cat >> ~/.ssh/config << EOF

Host bitbucket.org
    HostName bitbucket.org
    User git
    IdentityFile $ssh_key
    IdentitiesOnly yes
EOF
            ;;
        gitlab)
            cat >> ~/.ssh/config << EOF

Host gitlab.com
    HostName gitlab.com
    User git
    IdentityFile $ssh_key
    IdentitiesOnly yes
EOF
            ;;
    esac
done

# Set git config
# Extract username from email (everything before @) if name not provided
username="${email%%@*}"
git config --global user.name "${username}"
git config --global user.email "$email"

echo ""
echo "✓ Switched to $name ($description)"
echo "✓ Using SSH key: $ssh_key"
echo ""
echo "Current configuration:"
echo "  Name: $(git config --global user.name)"
echo "  Email: $(git config --global user.email)"
echo "  SSH key: $ssh_key"